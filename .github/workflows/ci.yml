name: CI and deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [24.x]

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v5

      - name: Setup Node.js ${{ matrix.node-version }}
        id: setup-node
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        id: install
        run: |
          npm ci
        # npx playwright install

      - name: Build
        id: build
        run: npm run build

      - name: Lint
        id: lint
        run: npm run lint

      #- name: Run tests
      #  id: tests
      #  run: npm run test

      # This will fail the workflow if either of the output directories are different
      # than expected.
      - name: Compare Directories
        id: diff
        run: |
          if [ ! -d dist/ ]; then
            echo "Expected dist/ directory does not exist.  See status below:"
            ls -la ./
            exit 1
          fi
          if [ "$(git diff --ignore-space-at-eol --text dist/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff --ignore-space-at-eol --text dist/
            exit 1
          fi
          if [ ! -d tests/ ]; then
            echo "Expected tests/ directory does not exist.  See status below:"
            ls -la ./
            exit 1
          fi
          if [ "$(git diff --ignore-space-at-eol --text tests/ | wc -l)" -gt "0" ]; then
            echo "Detected uncommitted changes after build. See status below:"
            git diff --ignore-space-at-eol --text tests/
            exit 1
          fi

      # If outdir was different than expected, upload the expected version as a
      # workflow artifact.
      - if: ${{ failure() && steps.diff.outcome == 'failure' }}
        name: Upload Artifact
        id: uploadResult
        uses: actions/upload-artifact@v4
        with:
          name: outdir-${{ matrix.node-version }}-diff
          path: |
            dist/
            test/

  build-pages:
    name: Build GitHub Pages
    needs: ci
    if: github.ref == 'refs/heads/main' && success()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        id: checkout
        uses: actions/checkout@v5

      - name: Setup Node
        id: setup-node
        uses: actions/setup-node@v6

      - name: Install dependencies
        id: install
        run: npm install

      - name: Build project
        id: build
        run: npm run build

      - name: Setup Pages
        id: setup-pages
        uses: actions/configure-pages@v5

      - name: Upload production-ready build files
        id: upload
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./dist

  deploy:
    name: GitHub Pages deploy
    needs: build-pages
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pages: write
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: Download artifact
        id: download
        uses: actions/download-artifact@v6
        with:
          path: ./dist

      - name: Deploy to GitHub Pages
        id: deploy-pages
        uses: actions/deploy-pages@v4

  itchio-deploy:
    name: Itch.io deploy
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pages: write
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: Checkout repo
        id: checkout
        uses: actions/checkout@v5

      - name: Setup Node
        id: setup-node
        uses: actions/setup-node@v6

      - name: Install dependencies
        id: install
        run: npm install

      - name: Build project
        id: build
        run: npm run build

      - name: Set Version
        run: |
          echo "version=${GITHUB_REF/refs\/heads\//}-${{ github.sha }}" >> $GITHUB_ENV

      - name: Upload to itch.io
        uses: robpc/itchio-upload-action@v1
        with:
          path: dist
          project: parnic/gift-roundup
          channel: html
          version: ${{ env.version }}
          api-key: ${{ secrets.ITCHIO_API_KEY }}
